
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FakeFactor framework for the estimation of jets misidentified taus with pyROOT.">
      
      
        <meta name="author" content="Nikita Shadskiy">
      
      
        <link rel="canonical" href="https://KIT-CMS.github.io/TauFakeFactors/">
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>TauFakeFactors</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#taufakefactors" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="TauFakeFactors" class="md-header__button md-logo" aria-label="TauFakeFactors" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TauFakeFactors
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              TauFakeFactors
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/KIT-CMS/TauFakeFactors/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    KIT-CMS/TauFakeFactors
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="TauFakeFactors" class="md-nav__button md-logo" aria-label="TauFakeFactors" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    TauFakeFactors
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/KIT-CMS/TauFakeFactors/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    KIT-CMS/TauFakeFactors
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    TauFakeFactors
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    TauFakeFactors
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-preselection" class="md-nav__link">
    <span class="md-ellipsis">
      Event preselection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fake-factor-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Fake Factor calculation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fake-factor-corrections" class="md-nav__link">
    <span class="md-ellipsis">
      Fake Factor corrections
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hints" class="md-nav__link">
    <span class="md-ellipsis">
      Hints
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-preselection" class="md-nav__link">
    <span class="md-ellipsis">
      Event preselection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fake-factor-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Fake Factor calculation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fake-factor-corrections" class="md-nav__link">
    <span class="md-ellipsis">
      Fake Factor corrections
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hints" class="md-nav__link">
    <span class="md-ellipsis">
      Hints
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/KIT-CMS/TauFakeFactors/edit/master/docs/index.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/KIT-CMS/TauFakeFactors/raw/master/docs/index.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="taufakefactors">TauFakeFactors<a class="headerlink" href="#taufakefactors" title="Permanent link">&para;</a></h1>
<p>FakeFactor framework for the estimation of jets misidentified taus with pyROOT.</p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>Clone the repository via</p>
<pre><code class="language-bash">git clone --recurse-submodules https://github.com/KIT-CMS/TauFakeFactors.git
</code></pre>
<p>The environment can be set up with conda via</p>
<pre><code class="language-bash">conda env create --file environment.yaml
</code></pre>
<p>General definitions like paths for all steps of the fake factor measurements should be defined in a <code>configs/ANALYSIS/ERA/common_settings.yaml</code> file (file name should be always stay the same).</p>
<p>The expected ntuple folder structure is NTUPLE_PATH/ERA/SAMPLE_TAG/CHANNEL/*.root</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ntuple_path</code></td>
<td><code>string</code></td>
<td>absolute path to the folder with the n-tuples on the dcache, a remote path is expected like "root://cmsxrootd-kit.gridka.de//store/user/USER/..."</td>
</tr>
<tr>
<td><code>tree</code></td>
<td><code>string</code></td>
<td>name of the tree in the n-tuple files ("ntuple" in CROWN)</td>
</tr>
<tr>
<td><code>era</code></td>
<td><code>string</code></td>
<td>data taking era (e.g. "2018, "2017", "2016preVFP", "2016postVFP")</td>
</tr>
<tr>
<td><code>tau_vs_jet_wps</code></td>
<td><code>list</code></td>
<td>list of tau ID vsJet working points to be written out in the preselection step (e.g. ["Medium", "VVVLoose"])</td>
</tr>
<tr>
<td><code>tau_vs_jet_wgt_wps</code></td>
<td><code>list</code></td>
<td>list of tau ID vsJet working point scale factors to be written out in the preselection step (e.g. ["Medium"])</td>
</tr>
</tbody>
</table>
<p>The output folder structure is OUTPUT_PATH/preselection/ERA/CHANNEL/*.root</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>output_path</code></td>
<td><code>string</code></td>
<td>absolute path where the files with the preselected events will be stored, a local path is expected like "/ceph/USER/..."</td>
</tr>
<tr>
<td><code>file_path</code></td>
<td><code>string</code></td>
<td>absolute path to the folder with the preselected files (should be the same as <code>output_path</code>) to be used for the fake factor calculation</td>
</tr>
<tr>
<td><code>workdir_name</code></td>
<td><code>string</code></td>
<td>relative path where the fake factor measurement output files will be stored; folder is produced in <code>workdir/</code></td>
</tr>
</tbody>
</table>
<h2 id="event-preselection">Event preselection<a class="headerlink" href="#event-preselection" title="Permanent link">&para;</a></h2>
<p>This framework is designed for n-tuples produced with CROWN as input. 
All information for the preselection step is defined in configuration files in the <code>configs/ANALYSIS/ERA/</code> folder using the <code>common_settings.yaml</code> file and a more specific config file. </p>
<p>The preselection config has the following parameters:</p>
<table>
<thead>
<tr>
<th>*   parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>channel</code></td>
<td><code>string</code></td>
<td>tau pair decay channels ("et", "mt", "tt")</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>In <code>processes</code> all the processes are defined that should be preprocessed. \
  The names are also used for the output file naming after the processing. \
  Each process needs two specifications:</p>
<table>
<thead>
<tr>
<th>subparameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tau_gen_modes</code></td>
<td><code>list</code></td>
<td>split of the events corresponding to the origin of the hadronic tau</td>
</tr>
<tr>
<td><code>samples</code></td>
<td><code>list</code></td>
<td>list of all sample tags corresponding to the specific process</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>The <code>tau_gen_modes</code> have following modes:</p>
<div class="highlight"><pre><span></span><code>subparameter | type | description
---|---|---
`T` | `string` | genuine tau
`J` | `string` | jet misidentified as a tau
`L` | `string` | lepton misidentified as a tau
`all` | `string` | if no split should be performed
</code></pre></div>
<ul>
<li>
<p>In <code>event_selection</code>, parameter for all selections that should be applied are defined. \
  This is basically a dictionary of cuts where the key is the name of a cut and the value is the cut itself as a string e.g. <code>had_tau_pt: "pt_2 &gt; 30"</code>. The name of a cut is not really important, it is only used as an output information in the terminal. A cut can only use variables which are in the ntuples.</p>
</li>
<li>
<p>In <code>mc_weights</code> all weights that should be applied for simulated samples are defined. \
  There are two types of weights.</p>
</li>
<li>Similar to <code>event_selection</code>, a weight can directly be specified and is then applied to all samples in the same way e.g. <code>lep_id: "id_wgt_mu_1"</code></li>
<li>But some weights are either sample specific or need additional information. Currently implemented options are:</li>
</ul>
<table>
<thead>
<tr>
<th>subparameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>generator</code></td>
<td><code>string</code></td>
<td>The normal generator weight is applied to all samples, if they aren't specified in the <code>"stitching"</code> sub-group. Stitching weights might be needed for DY+jets or W+jets, depending on which samples are used for them.</td>
</tr>
<tr>
<td><code>lumi</code></td>
<td><code>string</code></td>
<td>luminosity scaling, this depends on the era and uses the <code>era</code> parameter of the config to get the correct weight, so basically it's not relevant what is in the string</td>
</tr>
<tr>
<td><code>Z_pt_reweight</code></td>
<td><code>string</code></td>
<td>reweighting of the Z boson pt, the weight in the ntuple is used and only applied to DY+jets</td>
</tr>
<tr>
<td><code>Top_pt_reweight</code></td>
<td><code>string</code></td>
<td>reweighting of the top quark pt, the weight in the ntuple is used and only applied to ttbar</td>
</tr>
</tbody>
</table>
<ul>
<li>In <code>emb_weights</code> all weights that should be applied for embedded samples are defined. \
  Like for <code>event_selection</code> a weight can directly be specified and is then applied to all samples the same way e.g. <code>single_trigger: "trg_wgt_single_mu24ormu27"</code></li>
<li>In <code>output_features</code> the to be saved/needed features for the later calculations are listed.</li>
</ul>
<p>Scale factors for b-tagging and tau ID vs jet are applied on the fly during the FF calculation step. </p>
<p>To run the preselection step, execute the python script and specify the config file (relative path possible):</p>
<pre><code class="language-bash">python preselection.py --config-file configs/PATH/CONFIG.yaml
</code></pre>
<p>Further there are additional optional parameters: 
1. <code>--nthreads=SOME_INTEGER</code> to define the number of threads for the multiprocessing pool to run the sample processing in parallel. Default value is 8 (this should normally cover running all of the samples in parallel).
2.  <code>--ncores=SOME_INTEGER</code> to define the number of cores that should be used for each pool thread to speed up the ROOT dataframe calculation. Default value is 4.</p>
<h2 id="fake-factor-calculation">Fake Factor calculation<a class="headerlink" href="#fake-factor-calculation" title="Permanent link">&para;</a></h2>
<p>In this step the fake factors are calculated. This should be run after the preselection step.</p>
<p>All information for the FF calculation step is defined in a configuration file in the <code>configs/ANALYSIS/ERA/</code> folder using the <code>common_settings.yaml</code> and a more specific config file. \
The FF calculation config has the following parameters:</p>
<ul>
<li>General options for the calculation:</li>
</ul>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>channel</code></td>
<td><code>string</code></td>
<td>tau pair decay channels ("et", "mt", "tt")</td>
</tr>
<tr>
<td><code>use_embedding</code></td>
<td><code>bool</code></td>
<td>True if embedded sample should be used, False if only MC sample should be used</td>
</tr>
<tr>
<td><code>use_center_of_mass_bins</code></td>
<td><code>bool</code></td>
<td>Changes the x-data that is entering FF and correction calculation. If set then a center of mass value is used for the x-data, calculated from events entering the corresponding bin. If not set, the bin centers are used. Default is set to True. <br> <br>This will not affect FF and correction calculation that are set to <code>"binwise"</code> (the x-data values although displayed in plots are not used)</td>
</tr>
</tbody>
</table>
<ul>
<li>In <code>target_processes</code> the processes for which FFs should be calculated (normally for QCD, Wjets, ttbar) are defined. \
  Each target process needs some specifications:</li>
</ul>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>split_categories</code></td>
<td><code>dict</code></td>
<td>names of variables for the fake factor measurement in different phase space regions <ul><li>the FF measurement can be split based on variables in 1D or 2D (1 or 2 variables)</li><li>each category/variable has a <code>list</code> of orthogonal cuts (e.g. "njets" with "==1", "&gt;=2")</li><li> "njets", "nbtag", "tau_decaymode_2" or "deltaR_ditaupair" are already possible, other variables should be added during preprocessing step accordingly </li><li>at least one inclusive category needs to be specified (assuming variable is written out in preselection step)</li></ul> If a continous variable is used a window can be defined as <code>"&gt;=lower#&amp;&amp;#&lt;upper"</code> accordingly.</td>
</tr>
<tr>
<td><code>split_categories_binedges</code></td>
<td><code>dict</code></td>
<td>bin edge values for each <code>split_categories</code> variable <ul><li>number of bin edges should always be N(variable cuts)+1rections</td>
</tr>
<tr>
<td><code>non_closure</code></td>
<td><code>dict</code></td>
<td>this is only relevant for <code>DR_SR</code> corrections, since for this corrections additional fake factors are calculated. It's possible to calculated and apply non closure corrections to these fake factors before calculating the actual DR to SR correction.</td>
</tr>
</tbody>
</table>
<p>To run the FF correction step, execute the python script and specify the config file (relative path possible):</p>
<pre><code class="language-bash">python ff_corrections.py --config-file PATH/CONFIG.yaml 
</code></pre>
<p>There are two optional parameters <code>--skip-DRtoSR-ffs</code> and <code>--only-main-corrections</code>. The correction caclulation is done in 3 steps.\
The first step is to calculate additional fake factors which are needed for the final DR to SR correction. If this is already done, this step can be skipped using <code>--skip-DRtoSR-ffs</code>.\
The second step is to calculate non closure corrections for these additional DR to SR fake factors. If both steps are already done they can be skipped by using <code>--only-main-corrections</code>.\
The last step is to calculate all the specified corrections for the main fake factors.
</details>ons
  <code>non_closure</code> | <code>dict</code> | this is only relevant for <code>DR_SR</code> corrections, since for this corrections additional fake factors are calculated. It's possible to calculated and apply non closure corrections to these fake factors before calculating the actual DR to SR correction.</p>
<p>To run the FF correction step, execute the python script and specify the config file (relative path possible):</p>
<pre><code class="language-bash">python ff_corrections.py --config-file PATH/CONFIG.yaml 
</code></pre>
<p>There are two optional parameters <code>--skip-DRtoSR-ffs</code> and <code>--only-main-corrections</code>. The correction caclulation is done in 3 steps.\
The first step is to calculate additional fake factors which are needed for the final DR to SR correction. If this is already done, this step can be skipped using <code>--skip-DRtoSR-ffs</code>.\
The second step is to calculate non closure corrections for these additional DR to SR fake factors. If both steps are already done they can be skipped by using <code>--only-main-corrections</code>.\
The last step is to calculate all the specified corrections for the main fake factors.
</details>
  <code>SRlike_cuts</code> | <code>dict</code> | event selections for the signal-like region of the target process
  <code>ARlike_cuts</code> | <code>dict</code> | event selections for the application-like region of the target process
  <code>SR_cuts</code> | <code>dict</code> | event selections for the signal region (normally only needed for ttbar)
  <code>AR_cuts</code> | <code>dict</code> | event selections for the application region (normally only needed for ttbar)
  <code>var_dependence</code> | <code>string</code> | variable the FF measurement should depend on (normally pt of the hadronic tau e.g. <code>"pt_2"</code>)
  <code>var_bins</code> | <code>list</code> or <code>dict[list]</code> | bin edges for the variable specified in <code>var_dependence</code>. <br> Can either be a list representing the binning or a dictionary of lists, where keys correspond to the string representations of split categories defined in <code>split_categories</code>. <br> In the case of two split categories, the dictionary can be nested. If not all second split category elements share the first split category binning, the binning for the affected category must be specified separately. When using split binning, at least the first split category's bin edges must be fully defined.
  <code>fit_options</code> | <code>list</code> | a list of polynomials that should be considered for the fake factor fits can be defined with this parameter (default: <code>["poly_1"]</code>); futher it is possible to specify <code>"binwise"</code> which means that the histograms are written out directly without a fit 
  <code>limit_kwargs</code> | <code>dict</code> | this dictionary allows to define how the fitted function and its uncertainty are handled (also outside the measurement range); the default is that outside the range the fake factor functions stays constant but the up and down variations still increase/decrease; additionally negative fake factor values are not allowed and if present are set to 0</p>
<div class="highlight"><pre><span></span><code>Event selections can be defined the same way as in the preselection step `event_selection`. Only the tau vs jet ID cut is special because the name should always be `had_tau_id_vs_jet` (or `had_tau_id_vs_jet_*` in tt channel), this is needed to read out the working points from the cut string and apply the correct tau vs jet ID weights.
</code></pre></div>
<ul>
<li>In <code>process_fractions</code> specifications for the calculation of the process fractions are defined.</li>
</ul>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>processes</code></td>
<td><code>list</code></td>
<td>sample names (from the preprocessing step) of the processes for which the fractions should be stored in the correctionlib json, the sum of fractions of the specified samples is 1.</td>
</tr>
<tr>
<td><code>split_categories</code></td>
<td><code>dict</code></td>
<td>see <code>target_processes</code> (only in 1D)</td>
</tr>
<tr>
<td><code>AR_cuts</code></td>
<td><code>list</code></td>
<td>see <code>target_processes</code></td>
</tr>
<tr>
<td><code>SR_cuts</code></td>
<td><code>list</code></td>
<td>see <code>target_processes</code>, (optional) not needed for the fraction calculation</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code>**Note:** When using split binning for process fraction calculations, the `var_bins` parameter can also be defined in the same manner as for `target_processes`.
</code></pre></div>
<p>To run the FF calculation step, execute the python script and specify the config file (relative path possible):</p>
<pre><code class="language-bash">python ff_calculation.py --config-file PATH/CONFIG.yaml
</code></pre>
<h2 id="fake-factor-corrections">Fake Factor corrections<a class="headerlink" href="#fake-factor-corrections" title="Permanent link">&para;</a></h2>
<p>In this step the corrections for the fake factors are calculated. This should be run after the FF calculation step.</p>
<p>Currently two different correction types are implemented: 
1. non closure correction depending on a specific variable
2. DR to SR interpolation correction depending on a specific variable</p>
<p>All information for the FF correction calculation step is defined in a configuration file in the <code>configs/ANALYSIS/ERA/</code> folder using the <code>common_settings.yaml</code> and a more specific config file. Additional information is loaded from the used config in the previous FF calculation step (this is done automatically). \
The FF correction config has the following parameters:</p>
<ul>
<li>The expected input folder structure is workdir/WORKDIR_NAME/ERA/fake_factors/CHANNEL/*</li>
</ul>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>channel</code></td>
<td><code>string</code></td>
<td>tau pair decay channels ("et", "mt", "tt")</td>
</tr>
</tbody>
</table>
<ul>
<li>In <code>target_processes</code> the processes for which FF corrections should be calculated (normally for QCD, Wjets, ttbar) are defined.</li>
<li><code>split_categories</code> can be set for <code>non_closure</code> and <code>DR_SR</code> corrections (1D only) accordingly. <code>var_bins</code> declaration follow the specifications named in <code>FakeFactor calculation</code> section \
  Each target process needs some specifications:</li>
</ul>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>non_closure</code></td>
<td><code>dict</code></td>
<td>one or two non closure corrections can be specified indicated by the variable the correction should be calculated for (e.g. <code>pt_1</code>), also more than one closure correction are allowed and are calculated while already applying the correction that were already measured</td>
</tr>
<tr>
<td><code>DR_SR</code></td>
<td><code>dict</code></td>
<td>this correction should be specified only once per process in <code>target_processes</code></td>
</tr>
</tbody>
</table>
<p>Each correction has following specifications:</p>
<table>
<thead>
<tr>
<th>parameter</th>
<th>type</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>var_dependence</code></td>
<td><code>string</code></td>
<td>variable the FF correction measurement should depend on (e.g. <code>"pt_1"</code>)</td>
</tr>
<tr>
<td><code>split_categories</code></td>
<td><code>dict</code></td>
<td>Optional, analogous to <code>FakeFactor calculation</code> (only 1D).</td>
</tr>
<tr>
<td><code>var_bins</code></td>
<td><code>list</code> or <code>dict[list]</code></td>
<td>Analogous to <code>var_bins</code> in <code>FakeFactor calculation</code></td>
</tr>
<tr>
<td><code>correction_option</code></td>
<td><code>str</code></td>
<td>Definition of how a correction should be measured. Options are <code>"smoothed"</code> (applies a gaussian density kernel), <code>"binwise"</code> or both can also be combined into e.g. <code>"binwise#[0,]+smoothed"</code>, <code>"binwise#[-1,-2,]+smoothed"</code> or <code>"binwise#[0,]#[-1,]+smoothed"</code> where the nth-bin(s) is computed using binwise method and the rest in smoothed manner. For left bins, positive bin index is used. For last bins, the count is done using negative integers, starting at -1 (like in the example). If both options are provided, then the binwise calculation is applied for the stated left and right bins.</td>
</tr>
<tr>
<td><code>bandwidth</code></td>
<td><code>float</code></td>
<td>if <code>correction_option</code> includes <code>"smoothed"</code> this value can be set to adjust for the bandwidth used during smoothing procedure (has no effect on the result in case of <code>"binwise"</code>). If not set the default value of histogram range divided by 5 is chosen. <br> Can either be a float value representing the bandwidth for all corrections or a dictionary of float values, where keys correspond to the string representations of split categories defined in <code>split_categories</code>.</td>
</tr>
<tr>
<td><code>SRlike_cuts</code></td>
<td><code>dict</code></td>
<td>event selections for the signal-like region of the target process that should be replaced compared to the selection used in the previous FF calculation step</td>
</tr>
<tr>
<td><code>ARlike_cuts</code></td>
<td><code>dict</code></td>
<td>event selections for the application-like region of the target process that should be replaced compared to the selection used in the previous FF calculation step</td>
</tr>
<tr>
<td><code>AR_SR_cuts</code></td>
<td><code>dict</code></td>
<td>event selections for a switch from the determination region to the signal/application region, this is only relevant for <code>DR_SR</code> corrections</td>
</tr>
<tr>
<td><code>non_closure</code></td>
<td><code>dict</code></td>
<td>this is only relevant for <code>DR_SR</code> corrections, since for this corrections additional fake factors are calculated. It's possible to calculated and apply non closure corrections to these fake factors before calculating the actual DR to SR correction.</td>
</tr>
</tbody>
</table>
<p>To run the FF correction step, execute the python script and specify the config file (relative path possible):</p>
<pre><code class="language-bash">python ff_corrections.py --config-file PATH/CONFIG.yaml 
</code></pre>
<p>There are two optional parameters <code>--skip-DRtoSR-ffs</code> and <code>--only-main-corrections</code>. The correction caclulation is done in 3 steps.\
The first step is to calculate additional fake factors which are needed for the final DR to SR correction. If this is already done, this step can be skipped using <code>--skip-DRtoSR-ffs</code>.\
The second step is to calculate non closure corrections for these additional DR to SR fake factors. If both steps are already done they can be skipped by using <code>--only-main-corrections</code>.\
The last step is to calculate all the specified corrections for the main fake factors.
</details></p>
<h2 id="hints">Hints<a class="headerlink" href="#hints" title="Permanent link">&para;</a></h2>
<ul>
<li>check out <code>configs/general_definitions.py</code>, this file has many relevant definition for plotting (dictionaries for names) and correctionlib output information</li>
<li>check <code>ntuple_path</code> and <code>output_path</code> (preselection) and <code>file_path</code> and <code>workdir_name</code> (fake factors, corrections) in the used config files to avoid wrong inputs or outputs</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Nikita Shadskiy, Artur Monsch
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["content.action.edit", "content.action.view", "content.tooltips", "navigation.sections"], "search": "assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>